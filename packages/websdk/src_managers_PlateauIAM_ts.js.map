{"version":3,"file":"src_managers_PlateauIAM_ts.js","mappings":"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","sources":["webpack://websdk/./src/managers/PlateauIAM.ts"],"sourcesContent":["import { ISettingsIAM } from '@stechquick/algae/lib/quick/IPlateauUI';\nimport Keycloak from 'keycloak-js';\n// import { URLSearchParams } from 'url';\nimport { IPlateauIAM } from \"../../../../common/shrimp/interfaces/quick/IPlateauIAM\";\n\nexport class PlateauIAM implements IPlateauIAM {\n\n    public settingsIAM: ISettingsIAM | undefined\n\n    private refreshTime: number = 6000\n    private updateTime: number = 10\n\n    private initOptions: any = {\n        url: 'http://identity-provider.dev.rally.softtech/auth/',\n        realm: 'main',\n        clientId: 'ui-web-client',\n        onLoad: 'login-required',\n        pkceMethod: 'S256',\n        identityProvider: '',\n    }\n\n    //MAIN SECURITY OBJECT\n    private keycloak?: Keycloak.KeycloakInstance;\n    // private keycloak?: Keycloak;\n\n    //PLATEAU SECURITY OBJECT\n    private iamPlateau: undefined | { token: string | undefined, info: object | undefined } = undefined\n\n    public setOptions(initOptions: { url: string, realm: string, clientId: string, onLoad: string, pkceMethod: string, identityProvider: string }) {\n        try {\n            if (initOptions.identityProvider != undefined) {\n                if (typeof initOptions.identityProvider === 'object') {\n\n                    var subdomain = ''\n                    var ipUrlSplit = initOptions.url.split('.')\n                    var order = 2\n                    try {\n                        order = parseInt((<any>initOptions.identityProvider).order)\n                        if (order <= 0) {\n                            order = 2\n                        }\n                    } catch (error) {\n                        order = 2\n                    }\n\n                    if ((<any>initOptions.identityProvider).type === 'queryString') {\n                        var params = new URLSearchParams(window.location.search)\n                        if (params.get('subdomain') != null) {\n                            subdomain = <any>params.get('subdomain')\n                            // ipUrlSplit[1] = subdomain\n                            ipUrlSplit[order - 1] = subdomain\n                            this.initOptions.subdomain = subdomain\n                        }\n                        if (params.get('realm') != null) {\n                            initOptions.realm = <any>params.get('realm')\n                        }\n\n                    } else if ((<any>initOptions.identityProvider).type === 'subdomain') {\n                        var urlSplit = window.location.host.split('.')\n                        subdomain = urlSplit[0]     // optional parametre ile subdomain of subdomain alinabilir\n                        ipUrlSplit[order - 1] = subdomain\n                    }\n                    // ipUrlSplit[1] = subdomain               \n                    initOptions.url = ipUrlSplit.join('.')\n\n\n                } else if (initOptions.identityProvider.length > 1) {\n                    initOptions.url = window.location.protocol + '//' + window.location.host.replace(initOptions.identityProvider, 'identity-provider') + '/auth'\n                }\n\n            }\n\n            /*         \n                    turisui\n                    http://turisui.participant-turis-mr-484-dev.turispsql.plateaux.softtech\n                    http://identity-provider.participant-turis-mr-484-dev.turispsql.plateaux.softtech/auth\n             */\n\n\n            if (initOptions.url) this.initOptions.url = initOptions.url\n            if (initOptions.realm) this.initOptions.realm = initOptions.realm\n            if (initOptions.clientId) this.initOptions.clientId = initOptions.clientId\n            if (initOptions.onLoad) this.initOptions.onLoad = initOptions.onLoad\n            if (initOptions.pkceMethod) this.initOptions.pkceMethod = initOptions.pkceMethod\n            if (initOptions.identityProvider) this.initOptions.identityProvider = initOptions.identityProvider\n        } catch (error) {\n        }\n\n    }\n\n    public isAuthenticated() {\n        if (this.iamPlateau?.token != undefined) return true\n    }\n    public async init(callback: Function) {\n        this.keycloak = Keycloak(this.initOptions);\n        var auth = await this.keycloak.init({ onLoad: this.initOptions.onLoad, pkceMethod: this.initOptions.pkceMethod, checkLoginIframe: false })\n        if (typeof auth == 'boolean') {\n            if (!auth) {\n                window.location.reload();\n            } else {\n                this.constructIAMPlateau()\n            }\n            callback()\n        }\n    }\n    private constructIAMPlateau() {\n        if (this.iamPlateau == undefined) this.iamPlateau = { token: this.keycloak?.token, info: this.keycloak?.tokenParsed }\n        else this.iamPlateau.token = this.keycloak?.token\n\n        \n        // if (window.location.search) sessionStorage.setItem('queryParams', window.location.search);\n        if (window.location.search) document.cookie =  \"queryParamsIAM=\"+window.location.search+\";path=/;\"\n    }\n\n    public async refreshPromise() {\n        let isRefreshed: boolean | undefined = false;\n        try {\n            isRefreshed = await this.keycloak?.updateToken(this.updateTime);\n            this.constructIAMPlateau();\n        } catch (err) {\n            window.location.href = window.location.protocol + '//' + window.location.host;\n        }\n        return isRefreshed;\n    }\n\n\n    public logout() {\n        let getredirectURL = window.location.protocol + '//' + window.location.host\n        if ((this.initOptions.identityProvider).type === 'queryString') {\n            if (this.initOptions.realm) getredirectURL = window.location.protocol + '//' + window.location.host + '?realm=' + this.initOptions.realm\n            if (this.initOptions.subdomain) getredirectURL = window.location.protocol + '//' + window.location.host + '?subdomain=' + this.initOptions.subdomain\n            if (this.initOptions.realm && this.initOptions.subdomain) getredirectURL = window.location.protocol + '//' + window.location.host + '?realm=' + this.initOptions.realm + '&subdomain=' + this.initOptions.subdomain\n        }\n        console.log('getredirectURL:')\n        console.log(getredirectURL)\n        // const getredirectURL = this.initOptions.url\n        const options = { redirectUri: getredirectURL }\n        const logoutUrl = this.keycloak?.createLogoutUrl(options)\n        const options2={ redirectUri: logoutUrl }\n        this.keycloak?.logout(options2)\n    }\n\n    public getToken = () => {\n        if (this.iamPlateau != undefined)\n            return this.iamPlateau.token\n        else return undefined\n    }\n    public getInfo = () => {\n        if (this.iamPlateau != undefined)\n            return this.iamPlateau.info\n        else return undefined\n    }\n\n    public async login() {\n        var callback = () => {\n/*             setInterval(() => {\n                this.refresh()\n            }, this.refreshTime)\n */        }\n        await this.init(callback)\n    }\n}\n\n"],"names":[],"sourceRoot":""}